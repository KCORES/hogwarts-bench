# 实现计划

- [x] 1. 搭建项目结构和核心工具
  - 按照设计创建目录结构（src/、prompts/、tests/、data/）
  - 实现配置管理器以加载和验证 .env 设置
  - 实现 tiktoken 分词器包装器，用于编码、解码和边界检测
  - 实现文件 I/O 工具，用于读取小说和写入 JSONL 文件
  - 创建包含所有必需配置参数的 .env.example
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2. 实现带重试逻辑的 LLM 客户端
  - 使用 OpenAI Python SDK 创建 LLMClient 类
  - 实现带超时处理的单次生成方法
  - 实现带可配置并发的批量生成方法
  - 为网络和速率限制错误添加指数退避重试逻辑
  - 为失败的请求添加错误日志
  - _需求: 5.2, 5.3, 5.4, 5.5, 6.4, 6.5_

- [x] 3. 实现提示词模板管理
  - 创建 PromptTemplateManager 类以从 JSON 文件加载模板
  - 创建带占位符的默认题目生成提示词模板
  - 创建要求 JSON 格式输出的默认测试提示词模板
  - 实现从自定义文件路径加载模板
  - 添加模板结构验证
  - _需求: 3.5, 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 4. 实现题目验证器
  - 创建带结构验证的 QuestionValidator 类
  - 实现必需字段的 JSON 模式验证
  - 实现 question_type 值的内容验证
  - 实现答案-选项验证以确保答案是有效选项
  - 为多选题添加验证以确保至少 2 个干扰选项
  - _需求: 4.2, 4.3, 3.4_

- [x] 5. 实现采样策略
  - 创建带策略接口的采样模块
  - 实现分层采样，将小说分为 50k token 层
  - 实现整个小说的随机采样
  - 添加位置排序以确保顺序处理
  - _需求: 1.2, 1.3, 1.4, 1.5_

- [x] 6. 实现带边界对齐的上下文提取
  - 在分词器模块中创建上下文提取函数
  - 使用正则表达式实现句子边界检测（标点符号）
  - 使用双换行符实现段落边界检测
  - 如果在 100 个 token 内未找到边界，添加硬截断回退
  - 返回带调整的起始和结束位置的对齐上下文
  - _需求: 2.1, 2.2, 2.3_

- [x] 7. 实现题目生成核心逻辑
  - 创建带初始化的 QuestionGenerator 类
  - 实现编排管道的主 generate_questions 方法
  - 实现带 LLM 调用和验证的单题目生成
  - 使用 asyncio 添加并发题目生成
  - 为失败的生成实现重试逻辑
  - 将生成的题目保存到带元数据的 JSONL
  - _需求: 1.1, 2.4, 2.5, 3.1, 3.2, 3.3, 4.1, 4.4, 4.5, 5.1_

- [x] 8. 创建题目生成器 CLI
  - 使用 argparse 创建 generate.py CLI 脚本
  - 添加命令行参数：--novel、--question_nums、--sampling_strategy、--context_window_size、--concurrency、--retry_times、--output
  - 实现主函数以加载配置、初始化组件并运行生成
  - 添加进度日志和错误报告
  - 完成时添加摘要统计
  - _需求: 1.1, 1.2, 1.3, 5.1, 5.4_

- [x] 9. 实现带回退策略的答案解析器
  - 在 tester 包中创建答案解析器模块
  - 实现直接 JSON 解析作为主要策略
  - 实现正则提取作为回退策略
  - 返回解析的答案和解析状态
  - 处理边缘情况，如空响应或格式错误的 JSON
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [x] 10. 实现测试工具核心逻辑
  - 创建带初始化的 TestingTool 类
  - 通过提取前 N 个 token 实现上下文准备
  - 基于位置和填充大小实现题目过滤
  - 实现带 LLM 调用和答案解析的单题目测试
  - 使用 asyncio 添加并发测试
  - 将测试结果保存到带元数据的 JSONL
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 8.5_

- [x] 11. 创建测试工具 CLI
  - 使用 argparse 创建 test.py CLI 脚本
  - 添加命令行参数：--novel、--data_set、--context_length、--padding_size、--concurrency、--output
  - 实现主函数以加载配置、初始化组件并运行测试
  - 添加进度日志和错误报告
  - 完成时添加摘要统计
  - _需求: 7.1, 7.2, 7.4_

- [x] 12. 实现指标计算
  - 在 reporter 包中创建指标模块
  - 实现单选题的准确率计算
  - 实现多选题的精确率、召回率和 F1 分数计算
  - 实现所有多选题的宏平均计算
  - 添加结果分类（正确、部分正确、错误、解析错误）
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 13. 实现可视化生成器
  - 使用 Plotly 创建可视化模块
  - 实现散点图，X 轴为 token 位置，Y 轴为分数
  - 实现颜色编码：绿色表示正确，黄色表示部分正确，红色表示错误，灰色表示错误
  - 添加带题目详情的悬停工具提示
  - 使用移动平均实现趋势线计算
  - 返回用于嵌入的 Plotly HTML div
  - _需求: 10.3, 10.4, 10.5, 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 14. 实现报告生成器核心逻辑
  - 创建 ReportGenerator 类以加载和处理结果
  - 实现带测试配置和指标的摘要部分生成
  - 实现带随机错误案例采样的错误分析部分
  - 集成散点图可视化
  - 生成带嵌入式 CSS 和 JavaScript 的完整独立 HTML 文件
  - _需求: 10.1, 10.2, 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 15. 创建报告生成器 CLI
  - 使用 argparse 创建 report.py CLI 脚本
  - 添加命令行参数：--results、--output、--error_examples
  - 实现主函数以加载结果并生成报告
  - 为缺少或损坏的文件添加错误处理
  - 添加带输出文件路径的成功消息
  - _需求: 10.1_

- [x] 16. 创建示例配置和文档
  - 创建带所有配置参数和注释的 .env.example
  - 编写包含项目概述、安装和使用说明的 README.md
  - 为所有三个工具添加 CLI 使用示例
  - 记录提示词模板自定义过程
  - 为常见问题添加故障排除部分
  - _需求: 6.1, 6.2, 13.1, 13.2_

- [x] 17. 设置依赖项和包配置
  - 创建包含所有依赖项和版本约束的 requirements.txt
  - 创建用于包安装的 setup.py
  - 为所有包添加 __init__.py 文件
  - 为 CLI 脚本配置包入口点
  - _需求: 6.4_
